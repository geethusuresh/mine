{% load humanize %} {% load sec_filters %}
<!DOCTYPE html>
<html ng-app="security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="300">
    <title>Oneconsole | Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/static/asset/bootstrap-select.min.css">
     <link rel="stylesheet" type="text/css" href="/static/angular/angular-chart.min.css">
    <link rel="stylesheet" type="text/css" href="/static/security_monitoring/custom.css">
    {% include "components/css.html"%}
    <!-- date range picker -->
    <!-- <link href="/static/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css" /> -->
    <style type="text/css">
    #rcorners2 {
        border-radius: 25px;
        border: 2px solid #8AC007;
        padding: 20px;
        width: 200px;
        height: 150px;
    }

    #recently_closed .dataTables_length,
    #cust_await .dataTables_length {
        margin-left: 28% !important;
        margin-top: -29px;
    }

    .custom-box p {
        font-size: 16px;
    }
    #chartdiv {
        width   : 100%;
        height  : 300px;
    }
    </style>
    <script type="text/javascript">
    // setInterval(function() {
    //     window.location.reload();
    //   }, 300000);

    function popup_secured() {
        window.open("http://208.85.152.102/security/attackmap/", "_blank", "toolbar=no, scrollbars=yes, resizable=yes, top=0, left=0, width=1024, height=1000,location=no,menubar=no");
    }
    </script>
    <!--<script src="/static/customer/js/plugins/jquery/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="/static/customer/js/plugins/bootstrap/bootstrap.min.js" type="text/javascript"></script>-->
</head>
<!--  This body id is used to set the Data Table -->

<body class="fixed" style="font-size:13px" id="resolver_dashboard" ng-controller='niksundashboard' ng-init="init('{{source}}')">
    {% if "Customer_Dashboard" in request.session.logged_user_priv %} {% include "components/cust_header.html"%} {% else %} {% include "components/asset_header.html"%} {% endif %}
    <div class="wrapper">
        {% include "side_bar/customer.html"%}
        <div class="rightside">
            <div class="page-head" style="margin-top:10px">
                <h1 class="text-thin">Threat Management | <small>{{source}} Events</small></h1>
                <ol class="breadcrumb">
                    <li>You are here:</li>
                    <li><a href="/">Home</a></li>
                    <li><a href="/niksun/security/dashboard/">Threat Management</a></li>
                    <li class="active">{{ source }} Events</li>
                </ol>
            </div>
            {% if messages %}
            <ul>
                {% for message in messages %} {% if message.tags == 'success' %}
                <div class="alert alert-success">{{ message|safe }}</div>
                {% else %}
                <div class="alert alert-danger">{{ message|safe }}</div>
                {% endif %} {% endfor %}
            </ul>
            {% endif %}
            <!-- {% if not hosts %}
                <div class="alert alert-success" >No HOSTS Added.Please add hosts</div>
              {% endif %} -->
            <div class="content">
                <div class="row">
                    <div class="col-md-4 ">
                        <div class="col-md-12">
                        <div class="security-info-area ">
                            <a href="/security_tool/active_events/{{source}}">
                            <div class="icon-area"><img src="/static/images/active-events-icon.png" alt="Active Events"/></div>
                            <div class="security-threat-count-area"><h3>{{my_tickets_count}}</h3><span class="bluelabel">Active Events</span></div>
                            </a>
                        </div>
                        </div>
                        <div class="col-md-12">
                        <div class="security-info-area ">
                            <a href="/security_tool/all_events/{{source}}">
                            <div class="icon-area"><img src="/static/images/all-events-icon.png" alt="All Events"/></div>
                            <div class="security-threat-count-area"><h3>{{all_tickets_count}}</h3><span class="bluelabel">All Events</span></div>
                            </a>
                        </div>
                        </div>

                        </div>
                        <div class=" col-md-8 " style="margin:10px 0px;">
                            <div class="col-md-12">
                                <div class="panel">
                                    <div class="panel-heading">
                                      <p class="panel-title text-center"><strong>Events Trend</strong>(Last 7 days)</p>
                                    </div>
                                    <div class="panel-body text-center">
                                        <canvas id="line" class="chart chart-line" chart-data="data"
                                                  chart-labels="labels" chart-legend="true" chart-series="series" chart-options="options" height="60">
                                        </canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--<div class="row col-md-8 col-sm-12" style="margin:10px 0px;">-->
                            <!--<div>-->
                        <!--<div class="panel">-->
                            <!--<div class="panel-heading">-->
                                <!--<p class="panel-title text-center"><strong>Events Trend </strong>(Last 24 Hours) </p>-->
                            <!--</div>-->
                            <!--&lt;!&ndash; <div class="col-md-12" style="background-color: white!important;">-->
                        <!--<h4 class="text-center" >Events Graph (Last 24 Hours)</h4>-->
                      <!--</div> &ndash;&gt;-->
                            <!--<div class="panel-body">-->
                                <!--<canvas id="buyers" style="width:100%" height="50"></canvas>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                        <!--</div>-->



                    </div>
                <div class="row">
                    <div>
                        <form id="datepickerform" action="/security_tool/dashboard/{{source}}" enctype='multipart/form-data' method="POST">
                            {% csrf_token %}

                                    <div id="reportrange" class="pull-right col-lg-3 mar-rgt" style="background: #fff; margin-top: 50px; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 260px;">
                                        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                                        <span>{{ date1|date:"M d, Y"|default:"" }} - {{ date2|date:"M d, Y"|default:"" }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><b class="caret"></b>
                                    </div>
                                     <input type="hidden" name="start_date" id="start_date" value="">
                                    <input type="hidden" name="end_date" id="end_date" value="">
                                    <input type="hidden" name="date_label" id="date_label" value="">
                                </form>
                    </div>
                </div>
                <br><br>
                <div class="row">
                        <div class="col-md-6">
                            <div class="panel">
                                <div class="panel-body">
                                    <div  id="pie_chart_events_es" ></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="panel">
                                <div class="panel-body">
                                    <div  id="pie_chart_events" ></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="panel">
                                <div class="panel-body">
                                    <div  id="pie_chart_category"> </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="panel">
                                <div class="panel-body">
                                    <div  id="pie_chart_severity"> </div>
                                </div>
                            </div>
                        </div>
                    </div>



            </div>
        </div>




    {% if "Customer_Dashboard" in request.session.logged_user_priv %}
      {% include "components/customer_footer.html"%}
      {% else %}
      {% include "components/footer.html" %}
      {% endif %}
      {% include "components/service_request.html" %}
      {% include "security_monitoring/guage_meter.html" %}
      {% include "security_monitoring/redcanary/tickets_pie.html" %}
        <!-- // <script src="/static/customer/js/custom.js" type="text/javascript"></script> -->
        <script src="/static/js/highcharts/highcharts.js"></script>
        <script src="/static/js/highcharts/no-data-to-display.js"></script>
        <script src="/static/js/highcharts/highcharts-more.js"></script>
        <script src="/static/js/highcharts/exporting.js"></script>
        <script src="/static/js/chart.min.js"></script>
        <script type="text/javascript" src="/static/angular/angular.min.js"></script>
        <script type="text/javascript" src="/static/angular/angular-resource.js"></script>
        <script type="text/javascript" src="/static/angular/angular-route.js"></script>
        <script type="text/javascript" src="/static/angular/angular-chart.js"></script>
        <script type="text/javascript" src="/static/angular/app.js"></script>
        <script type="text/javascript" src="/static/angular/controllers.js"></script>
        <script src="/static/js/bootstrap-datepicker.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="/static/asset/bootstrap-select.min.js">
        <!-- // <script src="/static/daterangepicker/daterangepicker.js" type="text/javascript"></script> -->
        <!-- Date Range Picker js and css -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
        <script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
        <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
        <!----datepicker start-------->
        <script type="text/javascript">
            $(function() {

                if ('{{title_label}}' == "True"){
                    var date_label = "{{ date_label }}";
                    var date1_day = "{{ date1_day }}";
                    var date2_day = "{{ date2_day }}";
                    var d1 = new Date(date1_day);
                    var d2 = new Date(date2_day);
                    var start;
                    var end;
                    if(date_label == "Today"){
                        var start = moment();
                        var end = moment();
                    }
                    else if(date_label == "Yesterday"){
                        var start = moment().subtract(1, 'days');
                        var end = moment().subtract(1, 'days');
                    }
                    
                    else if(date_label == "Last 7 Days"){
                        var start = moment().subtract(6, 'days');
                        var end =  moment();
                    }
                    else if(date_label == "Last 15 Days"){
                        var start = moment().subtract(14, 'days');
                        var end =  moment();
                    }

                     else if(date_label == "Last 30 Days"){
                        var start = moment().subtract(29, 'days');
                        var end =  moment();
                    }
                    else if(date_label == "This Month") {
                        var start = moment().startOf('month');
                        var end = moment().endOf('month');
                    }
                    else if(date_label == "Last Month") {
                        var start = moment().subtract(1, 'month').startOf('month');
                        var end =  moment().subtract(1, 'month').endOf('month');
                    }
                    else if(date_label == "Custom Range"){
                        var start = d1;
                        var end =d2;
                    }
                    console.log("false");
                }
                else{
                console.log("true");
                var start = moment().subtract(14, 'days');
                var end = moment();

                }

                function cb(start, end) {
                    // $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                }

                $('#reportrange').daterangepicker({
                    startDate: start,
                    endDate: end,
                    ranges: {
                       'Today': [moment(), moment()],
                       'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                       'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                       'Last 15 Days': [moment().subtract(14, 'days'), moment()],
                       'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                       'This Month': [moment().startOf('month'), moment().endOf('month')],
                       'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    }
                }, cb);

                cb(start, end);

            });
        </script>
        <script type="text/javascript">
            $('#start_date').val('');
            $('#end_date').val('');

            $("#reportrange").on('apply.daterangepicker', function (ev, picker) {
                ev.preventDefault();
                var start_date= '';
                var end_date = '';
                start_date = picker.startDate.format('DD-MMM-YYYY  h:mm a');
                end_date = picker.endDate.format('DD-MMM-YYYY h:mm a');
                $('#start_date').val(start_date);
                $('#end_date').val(end_date);
                $('#date_label').val(picker.chosenLabel.trim());
                $('#datepickerform').submit();
            });

        </script>



        <script type="text/javascript">
        // $(document).ready(function() {
        //     $.ajax({
        //         url: "/niksun/draw/events/chart",
        //         type: "POST",
        //         dataType: "json",
        //         data: {
        //             csrfmiddlewaretoken: '{{ csrf_token }}'
        //         },
        //         success: function(data1) {
        //             labels = data1[1]
        //             values = data1[0]
        //                 // for (var key in data1){
        //                 //   labels.push(key);
        //                 //   values.push(data1[key]);
        //                 // }
        //             var data = {
        //                 labels: labels,
        //                 datasets: [{
        //                     label: "My Second dataset",
        //                     fillColor: "rgba(151,187,205,0.2)",
        //                     strokeColor: "rgba(151,187,205,1)",
        //                     pointColor: "rgba(151,187,205,1)",
        //                     pointStrokeColor: "#fff",
        //                     pointHighlightFill: "#fff",
        //                     pointHighlightStroke: "rgba(151,187,205,1)",
        //                     data: values
        //                 }]
        //             };
        //             var event_chart = document.getElementById('buyers').getContext('2d');
        //             new Chart(event_chart).Line(data);
        //         },
        //     });
        //     return false;
        // });

        if ('{{ title_label }}' == "True"){
            if ('{{ date_label }}' == "Custom Range") {
                var title = '{{ date1|date:"M d, Y"|default:"" }} - {{ date2|date:"M d, Y"|default:"" }}'
            }
            else{
                var title = '{{ date_label }}'
            }
        }
        else{
            var title = "Last {{ title_label }}"
        }
        function pieChart1() {
            $('#pie_chart_severity').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    style: {
                        font: 'bold 12px "Arial", Verdana, sans-serif'
                    },
                    text: 'All Events by Severity (' + title + ')'
                },
                exporting: {
                    enabled: false
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        },
                    }
                },
                colors: ["#FF0000", "#90ee7e", "#f45b5b", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee",
                "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
                series: [{
                    type: 'pie',
                    name: 'Percentage',
                    // data: data_list,
                    data: [
                        {% for item in severities %}
                            {
                            name: '{{item.internalpriority}}',
                            y: {{item.count}},
                            {% if item.internalpriority == "Critical" %}
                                color: "#BC0707" // Joe's color
                            {% endif %}
                            {% if item.internalpriority == "High" %}
                                color: "red" // Joe's color
                            {% endif %}
                            {% if item.internalpriority == "Medium" %}
                                color: "#2A82D7" // Joe's color
                            {% endif %}
                            {% if item.internalpriority == "Low" %}
                                color: "#008000" // Joe's color
                            {% endif %}
                            },
                        {% endfor %}
                    ],
                    point: {
                        events: {
                            click: function() {
                                view_tickets_only(this.name, 'severity')
                                // pieData(this.name, 'category')
                            }
                        }
                    }

                }]
            });
            $("#date_filter1").show();
            $("#date_filter2").show();
        }
        pieChart1();
        function pieChart2(data_list, title) {
            $('#pie_chart2').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    style: {
                        font: 'bold 16px "Trebuchet MS", Verdana, sans-serif'
                    },
                    text: 'Classification of alerts (' + title + ')'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Browser share',
                    data: data_list,
                    point: {
                        events: {
                            click: function() {
                                view_map(this.name, 'classification')
                            }
                        }
                    }
                }]
            });
        }
        // $.ajax({
        //     url: "/niksun/pie/data",
        //     type: "POST",
        //     dataType: "json",
        //     data: {
        //         is_dashboard: "True",
        //         csrfmiddlewaretoken: '{{ csrf_token }}'
        //     },
        //     success: function(data) {
        //         console.log('jjjjjjj********'+data)
        //         susp_list = JSON.parse(data['suspicious']);
        //         host_list = JSON.parse(data['host']);
        //         pieChart1(host_list, 'Last 24 Hours');
        //         // pieChart2(susp_list, 'Last 24 Hours');

        //     },
        // });

    function PieChartEvents() {
            $('#pie_chart_events').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    style: {
                        font: 'bold 12px "Arial", Verdana, sans-serif'
                    },
                    text: 'All Events by Source (' + title + ')'
                },
                exporting: {
                    enabled: false
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        },
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Percentage',
                    data: [
                        {% for item in alerts %}
                            {
                            name: '{{item.0}}',
                            y: {{item.1}},
                            {% if item.0 == "Niksun" %}
                                color: "#6A2181"
                            {% endif %}
                            {% if item.0 == "Redcanary" %}
                                color: "#625EB1"
                            {% endif %}
                            {% if item.0 == "LEM" %}
                                color: "#258572"
                            {% endif %}
                            {% if item.0 == "Varonis" %}
                                color: "#206C1C"
                            {% endif %}
                            {% if item.0 == "Zixcorp" %}
                                color: "#5E4F1D"
                            {% endif %}
                            {% if item.0 == "Isensor" %}
                                color: "#25667D"
                            {% endif %}
                            },
                        {% endfor %}
                    ],
                    point: {
                        events: {
                            click: function() {
                                console.log(this.name);
                                view_tickets_only(this.name, 'tickets');
                            }
                        }
                    }

                }]
            });
        }
         function PieChartCategory() {
            $('#pie_chart_category').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    style: {
                        font: 'bold 12px "Arial", Verdana, sans-serif'
                    },
                    text: 'All Events by Category (' + title + ')'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}',
                            style: {
                                width: '130px',
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        }
                    }
                },
                colors: ["#7cb5ec", "#f7a35c", "#90ee7e", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee",
                "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
                series: [{
                    type: 'pie',
                    name: 'Percentage',
                    data: [
                        {% for item in category_tickets %}
                            {
                            name: '{{item.0}}',
                            y: {{item.1}},
                            // color: "#DF5353" // Joe's color
                            },
                        {% endfor %}
                    ],
                    point: {
                        events: {
                            click: function() {
                                console.log(this.name, 'incident');
                                view_tickets_only(this.name, 'Category')
                            }
                        }
                    }
                }]
            });
        }
        function PieChartES() {
            $('#pie_chart_events_es').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    style: {
                        font: 'bold 12px "Arial", Verdana, sans-serif'
                    },
                    text: 'All Escalated Events (' + title + ')'
                },
                exporting: {
                    enabled: false
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y}',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        },
                    }
                },
                colors: ["#f45b5b", "#8085e9", "#8d4654", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee",
                "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
                series: [{
                    type: 'pie',
                    name: 'Percentage',
                    data: [
                        {% for item in internalpriority %}
                            {
                            name: '{{item.internalpriority}}',
                            y: {{item.count}},
                            {% if item.internalpriority == "Critical" %}
                                color: "#BC0707" // Joe's color
                            {% endif %}
                            {% if item.internalpriority == "High" %}
                                color: "red" // Joe's color
                            {% endif %}
                            {% if item.internalpriority == "Medium" %}
                                color: "#2A82D7" // Joe's color
                            {% endif %}
                            {% if item.internalpriority == "Low" %}
                                color: "#008000" // Joe's color
                            {% endif %}
                            },
                        {% endfor %}
                    ],
                    point: {
                        events: {
                            click: function() {
                                console.log(this.name, 'incident');
                                view_tickets_only(this.name, 'Escalated')
                            }
                        }
                    }

                }]
            });
        }
        PieChartEvents();
        PieChartCategory();
        PieChartES();
        </script>
        <script type="text/javascript">
        $(document).ready(function() {
            // $('#location_table21').dataTable({
            // "bPaginate": false,
            // "bLengthChange": false,
            // "bFilter": false,
            // "bInfo": false,
            // "bAutoWidth": false,
            // "order": [[ 1, "desc" ]]
            // });
            $('#table_index').DataTable();
            $('#agents_table').DataTable({
                "bPaginate": false,
                "bLengthChange": false,
                "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "aaSorting": []
            });
            // $('#attacker_table').DataTable({
            // "bPaginate": false,
            // "bLengthChange": false,
            // "bFilter": false,
            // "bInfo": false,
            // "bAutoWidth": false,
            // "aaSorting": []
            // });
            $("#from_date").datepicker({
                format: 'yyyy/mm/dd'
            }).on('changeDate', function(e) {
                $(this).datepicker('hide');
            });
            $("#to_date").datepicker({
                format: 'yyyy/mm/dd'
            }).on('changeDate', function(e) {
                $(this).datepicker('hide');
            });
        });
        // $('#suspicious_table').DataTable({
        // "bPaginate": false,
        // "bLengthChange": false,
        // "bFilter": false,
        // "bInfo": false,
        // "bAutoWidth": false,
        // "aaSorting": []
        // });


        // $('#hosts_table').dataTable({
        // "bPaginate": false,
        // "bLengthChange": false,
        // "bFilter": false,
        // "bInfo": false,
        // "bAutoWidth": false,
        // "aaSorting": []
        // });
        </script>
        <script type="text/javascript">
        var location_ajax = '';
        var type_ajax = '';
        var agent_ajax = '';
        var host_ajax = '';
        var source_ajax = '';
        var date = 0;
        var piedate = 0;
        var piedate2 = 0;
        var cat = '';
        var classi = '';

        function view_map(location, type, from_call) {
            if (type != 'category' && from_call == true) {
                date = 2;
                $("#date_span").html('(Last Week)')
                cat = ''
                classi = ''
            }
            if (type == 'category') {
                date = piedate
                cat = location
                if (date == 0) {
                    $("#date_span").html('(Last 24 Hrs)')
                } else if (date == 1) {
                    $("#date_span").html('(Last 48 Hrs)')
                } else if (date == 2) {
                    $("#date_span").html('(Last Week)')
                }
            }
            if (type == 'classification') {
                date = piedate2
                classi = location
                if (date == 0) {
                    $("#date_span").html('(Last 24 Hrs)')
                } else if (date == 1) {
                    $("#date_span").html('(Last 48 Hrs)')
                } else if (date == 2) {
                    $("#date_span").html('(Last Week)')
                }
            }
            l1_ajax = location;
            location_ajax = location;
            type_ajax = type;
            source_ajax = '';
            agent_ajax = '';
            host_ajax = '';

            // location
            // attackers
            // agent
            // susp
            // alert(type);
            // modalEventsTable();
            $.ajax({
                url: "/security/viewmap",
                type: "POST",
                dataType: "json",
                data: {
                    filter_value: location_ajax,
                    chart_type: type_ajax,
                    date: date,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    // var obj = $.parseJSON(data);
                    // draw_map(obj);
                    var key = [];
                    var value = [];
                    for (var prop in data) {
                        // alert(prop + " is " + data[prop]);
                        key.push(data[prop][1]);
                        value.push(data[prop][0]);
                    }
                    draw_map(key, value)
                    $("#cahrt_popup").modal('show');
                    $("#chart_div").show();
                    $("#modal_host_div").hide();
                    $("#modal_agent_div").hide();
                    $("#host_submit").hide();
                    $("#modal_source_div").hide();
                    $("#modal_events_div").hide();

                },
                error: function(xhr, errmsg, err) {
                    // alert(err);
                }
            });
            return false;
        }

        function modalEventsTable(temp) {
            final_list = [temp];
            if (source_ajax != '') {
                final_list.push(source_ajax);
                final_list.push('source');
                if (cat != '') {
                    final_list.push(cat)
                } else if (classi != '') {
                    final_list.push(classi)
                }
            } else if (agent_ajax != '') {
                final_list.push(agent_ajax);
                final_list.push('agent');
                if (cat != '') {
                    final_list.push(cat)
                } else if (classi != '') {
                    final_list.push(classi)
                }
            } else if (host_ajax != '') {
                final_list.push(host_ajax);
                final_list.push('host');
                if (cat != '') {
                    final_list.push(cat)
                } else if (classi != '') {
                    final_list.push(classi)
                }
            }

            if ($("#modal_events_table").hasClass('initialized')) {
                $('#modal_events_table').dataTable().fnDestroy();
            } else {
                $("#modal_events_table").addClass('initialized')
            }
            $('#modal_events_table').dataTable({
                "bLengthChange": false,
                // "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "processing": true,
                "ajax": {
                    "processing": true,
                    "url": "/popup/events",
                    "dataType": "json",
                    "type": "POST",
                    "data": {
                        filter_type: type_ajax,
                        filter_value: location_ajax,
                        extra: final_list,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    "dataSrc": ""
                },
                "columns": [{
                    "": "fields.0"
                }, {
                    "": "fields.1"
                }, {
                    "": "fields.2"
                }, {
                    "": "fields.3"
                }],
            });
            $("#modal_host_div").hide();
            $("#host_submit").hide();
            $("#modal_agent_div").hide();
            $("#modal_source_div").hide();
            $("#chart_div").hide();
            $("#modal_events_div").show();
        }

        function fetch_data() {
            if ($("input[name=person1]:checked")) {
                var temp = $("input[name=person1]:checked");
                var $td = $(temp).closest('td').next('td');
                var $th = $td.closest('table').find('th').eq($td.index());
                var f_type = $th.html();
                var f_value = $td.html().replace(/\&gt;/g, ">");
                if (f_type == 'Source IP') {
                    source_ajax = f_value;
                    agent_ajax = '';
                    host_ajax = '';
                } else if (f_type == 'Agent') {
                    agent_ajax = f_value;
                    source_ajax = '';
                    host_ajax = '';
                } else if (f_type == 'Host') {
                    host_ajax = f_value;
                    agent_ajax = '';
                    source_ajax = '';
                }
                ext_list = []
                if (cat != '') {
                    ext_list.push('category')
                    ext_list.push(cat)
                } else if (classi != '') {
                    ext_list.push('classification')
                    ext_list.push(classi)
                }
                // if (f_type == 'Agent'){
                //   a_value = f_value.replace(/\&gt;/g,">")
                // }
                $.ajax({
                    url: "/security/dashboard/filter",
                    type: "POST",
                    dataType: "json",
                    data: {
                        filter_value: f_value,
                        filter_type: f_type,
                        date: date,
                        temp_list: ext_list,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data) {
                        // var obj = $.parseJSON(data);
                        // draw_map(obj);
                        var key = [];
                        var value = [];
                        for (var prop in data) {
                            //   // alert(prop + " is " + data[prop]);
                            key.push(data[prop][1]);
                            value.push(data[prop][0]);
                        }
                        draw_map(key, value);
                        $("#chart_div").show();
                        $("#modal_host_div").hide();
                        $("#modal_agent_div").hide();
                        $("#host_submit").hide();
                        $("#modal_source_div").hide();
                        // $("#cahrt_popup").modal('toggle');

                    },
                    error: function(xhr, errmsg, err) {
                        // alert(err);
                    }
                });
                return false;
                // alert($("input[name=person1]:checked").val());
            }
        }

        function tempf(dat) {
            $("#chart_div").hide();
            $("#modal_events_div").show();
        }
        var chart;

        function draw_map(key, value) {

            chart = new Highcharts.Chart({
                chart: {
                    type: 'column',
                    renderTo: 'chart_div',
                },
                title: {
                    text: ''
                },
                exporting: {
                    enabled: false
                },
                xAxis: {
                    min: 0,
                    max: 5,
                    categories: key,
                    labels: {
                        rotation: -45
                    },
                },
                scrollbar: {
                    enabled: false,
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Count'
                    }
                },

                tooltip: {
                    formatter: function() {
                        return '' +
                            this.series.name + ': ' + this.y;
                    }
                },

                plotOptions: {
                    column: {
                        minPointLength: 4
                    },
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            format: '{point.y}'
                        }
                    }
                },

                series: [{
                    allowPointSelect: true,
                    type: 'column',
                    color: '#FF0000',
                    name: 'Events',
                    data: value,
                    point: {
                        events: {
                            click: function() {
                                modalEventsTable(this.category);
                            }
                        }
                    }
                }]
            });
        }
        $("#fetch").click(function() {
            if ($("#from_date").val() && $("#to_date").val()) {
                $.ajax({
                    url: "/security/modal/viewmap",
                    type: "POST",
                    dataType: "json",
                    data: {
                        filter_value: location_ajax,
                        chart_type: type_ajax,
                        from_date: $("#from_date").val(),
                        to_date: $("#to_date").val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data) {
                        // var obj = $.parseJSON(data);
                        // draw_map(obj);
                        // var key=[];
                        // var value=[];
                        // for (var prop in data) {
                        //   // alert(prop + " is " + data[prop]);
                        //   key.push(prop);
                        //   value.push(data[prop]);
                        // }
                        // draw_map(key,value)


                    },
                    error: function(xhr, errmsg, err) {
                        // alert(err);
                    }
                });
                return false;
            }
        });

        function modalHostTable() {
            if ($("#modal_host_table").hasClass('initialized')) {
                $('#modal_host_table').dataTable().fnDestroy();
            } else {
                $("#modal_host_table").addClass('initialized')
            }
            $('#modal_host_table').dataTable({
                "bLengthChange": false,
                "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "processing": true,
                "ajax": {
                    "processing": true,
                    "url": "/popup/hosts",
                    "dataType": "json",
                    "type": "POST",
                    "data": {
                        // filter_type2:type_ajax,
                        // filter_value2:location,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    "dataSrc": ""
                },
                "columns": [
                    // { "": "fields.id",sClass: "hidden" },
                    {
                        "": "",
                        "bSortable": false,
                    }, {
                        "": "fields.server_name"
                    },
                    // { "": "fields.event_data" },
                    // { "": "fields.event_record_time" },
                ],
                "columnDefs": [{
                    "targets": 0,
                    "data": "fields.id",
                    "defaultContent": "<input type='radio' name='person1' value=" + "data" + ">"
                }]
            });
            $("#modal_host_div").show();
            $("#host_submit").show();
            $("#chart_div").hide();
            $("#modal_events_div").hide();
            $("#modal_source_div").hide();
            $("#modal_agent_div").hide();
        }

        function modalAgentTable() {
            if ($("#modal_agent_table").hasClass('initialized')) {
                $('#modal_agent_table').dataTable().fnDestroy();
            } else {
                $("#modal_agent_table").addClass('initialized')
            }
            $('#modal_agent_table').dataTable({
                "bLengthChange": false,
                "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "processing": true,
                "ajax": {
                    "processing": true,
                    "url": "/popup/agents",
                    "dataType": "json",
                    "type": "POST",
                    "data": {
                        // filter_type2:type_ajax,
                        // filter_value2:location,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    "dataSrc": ""
                },
                "columns": [
                    // { "": "fields.id",sClass: "hidden" },
                    {
                        "": "",
                        "bSortable": false,
                    }, {
                        "": "fields.agent_name"
                    },
                    // { "": "fields.event_data" },
                    // { "": "fields.event_record_time" },
                ],
                "columnDefs": [{
                    "targets": 0,
                    "data": "fields.id",
                    "defaultContent": "<input type='radio' name='person1' value=" + "data" + ">"
                }]
            });
            $("#modal_agent_div").show();
            $("#host_submit").show();
            $("#modal_host_div").hide();
            $("#chart_div").hide();
            $("#modal_events_div").hide();
            $("#modal_source_div").hide();
        }

        function modalSourceTable() {
            if ($("#modal_source_table").hasClass('initialized')) {
                $('#modal_source_table').dataTable().fnDestroy();
            } else {
                $("#modal_source_table").addClass('initialized')
            }
            $('#modal_source_table').dataTable({
                "bLengthChange": false,
                "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "processing": true,
                "ajax": {
                    "processing": true,
                    "url": "/popup/source",
                    "dataType": "json",
                    "type": "POST",
                    "data": {
                        // filter_type2:type_ajax,
                        // filter_value2:location,
                        date: date,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    "dataSrc": ""
                },
                "columns": [
                    // { "": "fields.id",sClass: "hidden" },
                    {
                        "": "",
                        "bSortable": false,
                    }, {
                        "": "fields.ip"
                    },
                    // { "": "fields.event_data" },
                    // { "": "fields.event_record_time" },
                ],
                "columnDefs": [{
                    "targets": 0,
                    "data": "fields.id",
                    "defaultContent": "<input type='radio' name='person1' value=" + "data" + ">"
                }]
            });
            $("#modal_source_div").show();
            $("#modal_agent_div").hide();
            $("#host_submit").show();
            $("#modal_host_div").hide();
            $("#chart_div").hide();
            $("#modal_events_div").hide();
        }

        function filterBy(val) {
            if (val == 'hosts') {
                modalHostTable();
            } else if (val == 'agents') {
                modalAgentTable();
            } else if (val == 'source') {
                modalSourceTable();
            }
            // alert(val);
        }

        function changeChart(dat) {
            // options.chart.renderTo = 'chart_div';
            $("#modal_host_div").hide();
            $("#host_submit").hide();
            $("#modal_agent_div").hide();
            $("#modal_source_div").hide();
            if (dat == 'bar') {
                chart.series[0].update({
                    type: "bar"
                });
                $("#chart_div").show();
                $("#modal_events_div").hide();
            } else if (dat == 'line') {
                chart.series[0].update({
                    type: "line"
                });
                $("#chart_div").show();
                $("#modal_events_div").hide();
            } else if (dat == 'area') {
                chart.series[0].update({
                    type: "area"
                });
                $("#chart_div").show();
                $("#modal_events_div").hide();
            } else if (dat == 'events') {
                $("#chart_div").hide();
                $("#modal_events_div").show();
            }
        }
        $("#l_week0").click(function() {
            date = 0;
            piedate = 0;
            piedate2 = 0;
            $("#date_span").html('(Last 24 Hrs)')
            view_map(location_ajax, type_ajax);
            $("#chart_div").show();
            $("#modal_events_div").hide();
        });
        $("#l_week").click(function() {
            date = 1;
            piedate = 1;
            piedate2 = 1;
            $("#date_span").html('(Last 48 Hrs)')
            view_map(location_ajax, type_ajax);
            $("#chart_div").show();
            $("#modal_events_div").hide();
        });
        $("#t_month").click(function() {
            date = 2;
            piedate = 2;
            piedate2 = 2;
            $("#date_span").html('(Last Week)')
            view_map(location_ajax, type_ajax);
            $("#chart_div").show();
            $("#modal_events_div").hide();
        });
        $("#l_month").click(function() {
            date = 3;
            piedate = 3;
            piedate2 = 3;
            $("#date_span").html('(Last Month)')
            view_map(location_ajax, type_ajax);
            $("#chart_div").show();
            $("#modal_events_div").hide();
        });
        //   $('#cahrt_popup').on('hidden.bs.modal', function () {
        //     $("#date_span").html('(Last Week)')
        //     // do something
        // })
        </script>
        <script>
        function highlight(){

            var source = "{{ source }}"
            if (source == "Niksun"){
            $("#nik_event").addClass("active");
            }
            else if(source == "Redcanary"){
            $("#red_event").addClass("active");
            }
            else if(source == "LEM"){
            $("#lem_event").addClass("active");
            }
            else if(source == "Isensor"){
            $("#isen_event").addClass("active");
            }
            else if(source == "Varonis"){
            $("#var_event").addClass("active");
            }
            else if(source == "Zixcorp"){
            $("#zix_event").addClass("active");
            }

        }
        window.onload = highlight;


        $("#sec_open").css('display', 'block');
        $("#security").addClass("active");
        $(".close").click(function() {
            $("div").remove('.alert-wrap');
        });
        </script>
</body>

</html>
